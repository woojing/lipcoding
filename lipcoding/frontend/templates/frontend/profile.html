{% extends 'frontend/base.html' %}

{% block title %}í”„ë¡œí•„ ê´€ë¦¬ | ë©˜í† -ë©˜í‹° ë§¤ì¹­ ì‹œìŠ¤í…œ{% endblock %}

{% block navbar %}
<div class="navbar bg-base-100 shadow-lg">
    <div class="navbar-start">
        <a class="btn btn-ghost text-xl" href="/dashboard/">
            <span class="text-primary">ğŸ’¡</span>
            ë©˜í† ë§ ë§¤ì¹­
        </a>
    </div>
    
    <div class="navbar-center hidden lg:flex">
        <ul class="menu menu-horizontal px-1">
            <li><a href="/dashboard/" class="btn btn-ghost">ëŒ€ì‹œë³´ë“œ</a></li>
            <li><a href="/profile/" class="btn btn-ghost btn-active">í”„ë¡œí•„</a></li>
            <li x-show="userRole === 'mentee'"><a href="/mentors/" class="btn btn-ghost">ë©˜í†  ì°¾ê¸°</a></li>
            <li><a href="/requests/" class="btn btn-ghost">ë§¤ì¹­ ìš”ì²­</a></li>
        </ul>
    </div>
    
    <div class="navbar-end">
        <div class="dropdown dropdown-end">
            <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                <div class="w-10 rounded-full">
                    <img id="navbar-avatar" x-bind:src="profileData.imageUrl" x-bind:alt="profileData.name + ' í”„ë¡œí•„'" />
                </div>
            </div>
            <ul class="menu menu-sm dropdown-content bg-base-100 rounded-box z-50 mt-3 w-52 p-2 shadow">
                <li class="menu-title">
                    <span x-text="profileData.name"></span>
                    <span class="badge badge-primary badge-sm" x-text="profileData.role === 'mentor' ? 'ë©˜í† ' : 'ë©˜í‹°'"></span>
                </li>
                <li><a href="/profile/">í”„ë¡œí•„ í¸ì§‘</a></li>
                <li><a @click="logout()">ë¡œê·¸ì•„ì›ƒ</a></li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8" x-data="profilePage()">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold">í”„ë¡œí•„ ê´€ë¦¬</h1>
        <a href="/dashboard/" class="btn btn-outline">ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- í”„ë¡œí•„ ë¯¸ë¦¬ë³´ê¸° -->
        <div class="lg:col-span-1">
            <div class="card bg-base-100 shadow-xl sticky top-4">
                <div class="card-body items-center text-center">
                    <h2 class="card-title">í”„ë¡œí•„ ë¯¸ë¦¬ë³´ê¸°</h2>
                    
                    <div class="avatar">
                        <div class="w-32 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                            <img 
                                id="profile-photo"
                                x-bind:src="profileData.imageUrl" 
                                x-bind:alt="profileData.name + ' í”„ë¡œí•„'"
                                onerror="this.src='https://placehold.co/500x500.jpg?text=USER'"
                            />
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-semibold" x-text="profileData.name || 'ì´ë¦„ ì—†ìŒ'"></h3>
                    <p class="text-base-content/70" x-text="profileData.email"></p>
                    
                    <div class="badge badge-primary" x-text="profileData.role === 'mentor' ? 'ë©˜í† ' : 'ë©˜í‹°'"></div>
                    
                    <p class="text-sm text-center mt-4" x-text="profileData.bio || 'ìê¸°ì†Œê°œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'"></p>
                    
                    <!-- ë©˜í† ì˜ ê²½ìš° ìŠ¤í‚¬ í‘œì‹œ -->
                    <template x-if="profileData.role === 'mentor'">
                        <div class="mt-4">
                            <h4 class="font-semibold mb-2">ê¸°ìˆ  ìŠ¤íƒ</h4>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="skill in profileData.skills" :key="skill">
                                    <div class="badge badge-outline" x-text="skill"></div>
                                </template>
                                <div x-show="!profileData.skills || profileData.skills.length === 0" class="text-sm text-base-content/50">
                                    ê¸°ìˆ  ìŠ¤íƒì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
        
        <!-- í”„ë¡œí•„ í¸ì§‘ í¼ -->
        <div class="lg:col-span-2">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">í”„ë¡œí•„ ì •ë³´ ìˆ˜ì •</h2>
                    
                    <form @submit.prevent="updateProfile()" class="space-y-6">
                        <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">í”„ë¡œí•„ ì´ë¯¸ì§€</span>
                                <span class="label-text-alt">JPG, PNG íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥ (ìµœëŒ€ 1MB)</span>
                            </label>
                            <input 
                                type="file" 
                                id="profile"
                                class="file-input file-input-bordered w-full" 
                                accept="image/jpeg,image/png"
                                @change="handleImageUpload($event)"
                            />
                        </div>
                        
                        <!-- ì´ë¦„ -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">ì´ë¦„ *</span>
                            </label>
                            <input 
                                type="text" 
                                id="name"
                                placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" 
                                class="input input-bordered"
                                x-model="profileData.name"
                                required
                            />
                        </div>
                        
                        <!-- ìê¸°ì†Œê°œ -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">ìê¸°ì†Œê°œ</span>
                            </label>
                            <textarea 
                                id="bio"
                                class="textarea textarea-bordered h-24" 
                                placeholder="ìì‹ ì„ ì†Œê°œí•´ì£¼ì„¸ìš”"
                                x-model="profileData.bio"
                            ></textarea>
                        </div>
                        
                        <!-- ë©˜í† ì˜ ê²½ìš° ìŠ¤í‚¬ ì…ë ¥ -->
                        <template x-if="profileData.role === 'mentor'">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">ê¸°ìˆ  ìŠ¤íƒ</span>
                                    <span class="label-text-alt">ì½¤ë§ˆ(,)ë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="skillsets"
                                    placeholder="React, Vue, Node.js" 
                                    class="input input-bordered"
                                    x-model="skillsInput"
                                    @input="updateSkills()"
                                />
                                <div class="flex flex-wrap gap-2 mt-2">
                                    <template x-for="skill in profileData.skills" :key="skill">
                                        <div class="badge badge-primary gap-2">
                                            <span x-text="skill"></span>
                                            <button type="button" @click="removeSkill(skill)" class="btn btn-xs btn-circle btn-ghost">âœ•</button>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                        
                        <!-- ì œì¶œ ë²„íŠ¼ -->
                        <div class="form-control mt-8">
                            <button 
                                type="submit" 
                                id="save"
                                class="btn btn-primary"
                                :disabled="loading"
                            >
                                <span x-show="loading" class="loading loading-spinner loading-xs"></span>
                                <span x-text="loading ? 'ì €ì¥ ì¤‘...' : 'í”„ë¡œí•„ ì €ì¥'"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function profilePage() {
    return {
        loading: false,
        profileData: {
            id: '',
            name: '',
            email: '',
            role: '',
            bio: '',
            skills: [],
            imageUrl: 'https://placehold.co/500x500.jpg?text=USER'
        },
        skillsInput: '',
        imageBase64: '',
        
        async init() {
            await this.loadProfile();
        },
        
        async loadProfile() {
            try {
                const response = await axios.get('/me');
                const user = response.data;
                
                this.profileData = {
                    id: user.id,
                    name: user.profile.name || '',
                    email: user.email,
                    role: user.role,
                    bio: user.profile.bio || '',
                    skills: user.profile.skills || [],
                    imageUrl: `http://localhost:8080/api/images/${user.role}/${user.id}`
                };
                
                // ìŠ¤í‚¬ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                this.skillsInput = this.profileData.skills.join(', ');
                
            } catch (error) {
                console.error('Failed to load profile:', error);
                showToast('í”„ë¡œí•„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            }
        },
        
        async handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // íŒŒì¼ í¬ê¸° ê²€ì¦ (1MB)
            if (file.size > 1024 * 1024) {
                showToast('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 1MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
                event.target.value = '';
                return;
            }
            
            // íŒŒì¼ í˜•ì‹ ê²€ì¦
            if (!['image/jpeg', 'image/png'].includes(file.type)) {
                showToast('JPG ë˜ëŠ” PNG íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
                event.target.value = '';
                return;
            }
            
            try {
                // Base64 ì¸ì½”ë”©
                this.imageBase64 = await encodeImageToBase64(file);
                
                // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.profileData.imageUrl = e.target.result;
                };
                reader.readAsDataURL(file);
                
                showToast('ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'success');
                
            } catch (error) {
                console.error('Image upload error:', error);
                showToast('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        },
        
        updateSkills() {
            this.profileData.skills = this.skillsInput
                .split(',')
                .map(skill => skill.trim())
                .filter(skill => skill.length > 0);
        },
        
        removeSkill(skillToRemove) {
            this.profileData.skills = this.profileData.skills.filter(skill => skill !== skillToRemove);
            this.skillsInput = this.profileData.skills.join(', ');
        },
        
        async updateProfile() {
            this.loading = true;
            
            try {
                const updateData = {
                    id: this.profileData.id,
                    name: this.profileData.name,
                    role: this.profileData.role,
                    bio: this.profileData.bio
                };
                
                // ë©˜í† ì˜ ê²½ìš° ìŠ¤í‚¬ ì¶”ê°€
                if (this.profileData.role === 'mentor') {
                    updateData.skills = this.profileData.skills;
                }
                
                // ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œëœ ê²½ìš° ì¶”ê°€
                if (this.imageBase64) {
                    updateData.image = this.imageBase64;
                }
                
                await axios.put('/profile', updateData);
                
                showToast('í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                
                // ì´ë¯¸ì§€ Base64 ì´ˆê¸°í™”
                this.imageBase64 = '';
                
                // ë„¤ë¹„ê²Œì´ì…˜ ì•„ë°”íƒ€ ì—…ë°ì´íŠ¸
                const navbarAvatar = document.getElementById('navbar-avatar');
                if (navbarAvatar && updateData.image) {
                    navbarAvatar.src = this.profileData.imageUrl;
                }
                
            } catch (error) {
                console.error('Profile update error:', error);
                showToast(
                    error.response?.data?.error || 'í”„ë¡œí•„ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 
                    'error'
                );
            } finally {
                this.loading = false;
            }
        },
        
        logout() {
            localStorage.removeItem('jwt_token');
            delete axios.defaults.headers.common['Authorization'];
            window.location.href = '/';
        }
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ í† í° í™•ì¸
document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('jwt_token');
    if (!token) {
        window.location.href = '/';
    }
});
</script>
{% endblock %}
