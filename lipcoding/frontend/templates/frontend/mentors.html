{% extends 'frontend/base.html' %}

{% block title %}ë©˜í†  ì°¾ê¸° | ë©˜í† -ë©˜í‹° ë§¤ì¹­ ì‹œìŠ¤í…œ{% endblock %}

{% block navbar %}
<div class="navbar bg-base-100 shadow-lg">
    <div class="navbar-start">
        <div class="dropdown lg:hidden">
            <div tabindex="0" role="button" class="btn btn-ghost">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </div>
            <ul class="menu menu-sm dropdown-content bg-base-100 rounded-box z-50 mt-3 w-52 p-2 shadow">
                <li><a href="/dashboard/">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="/profile/">í”„ë¡œí•„</a></li>
                <li><a href="/mentors/">ë©˜í†  ì°¾ê¸°</a></li>
                <li><a href="/requests/">ë§¤ì¹­ ìš”ì²­</a></li>
            </ul>
        </div>
        <a class="btn btn-ghost text-xl" href="/dashboard/">
            <span class="text-primary">ğŸ’¡</span>
            ë©˜í† ë§ ë§¤ì¹­
        </a>
    </div>
    
    <div class="navbar-center hidden lg:flex">
        <ul class="menu menu-horizontal px-1">
            <li><a href="/dashboard/" class="btn btn-ghost">ëŒ€ì‹œë³´ë“œ</a></li>
            <li><a href="/profile/" class="btn btn-ghost">í”„ë¡œí•„</a></li>
            <li><a href="/mentors/" class="btn btn-ghost btn-active">ë©˜í†  ì°¾ê¸°</a></li>
            <li><a href="/requests/" class="btn btn-ghost">ë§¤ì¹­ ìš”ì²­</a></li>
        </ul>
    </div>
    
    <div class="navbar-end">
        <div class="dropdown dropdown-end">
            <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                <div class="w-10 rounded-full">
                    <img x-bind:src="userImage" x-bind:alt="userName + ' í”„ë¡œí•„'" />
                </div>
            </div>
            <ul class="menu menu-sm dropdown-content bg-base-100 rounded-box z-50 mt-3 w-52 p-2 shadow">
                <li class="menu-title">
                    <span x-text="userName"></span>
                    <span class="badge badge-primary badge-sm">ë©˜í‹°</span>
                </li>
                <li><a href="/profile/">í”„ë¡œí•„ í¸ì§‘</a></li>
                <li><a @click="logout()">ë¡œê·¸ì•„ì›ƒ</a></li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8" x-data="mentorsPage()">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold">ë©˜í†  ì°¾ê¸°</h1>
        <a href="/dashboard/" class="btn btn-outline">ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
    
    <!-- ê²€ìƒ‰ ë° í•„í„° ì„¹ì…˜ -->
    <div class="card bg-base-100 shadow-xl mb-8">
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- ê¸°ìˆ  ìŠ¤íƒ ê²€ìƒ‰ -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">ê¸°ìˆ  ìŠ¤íƒìœ¼ë¡œ ê²€ìƒ‰</span>
                    </label>
                    <input 
                        type="text" 
                        id="search"
                        placeholder="React, Vue, Node.js ë“±" 
                        class="input input-bordered"
                        x-model="searchSkill"
                        @input="searchMentors()"
                    />
                </div>
                
                <!-- ì •ë ¬ ê¸°ì¤€ -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">ì •ë ¬ ê¸°ì¤€</span>
                    </label>
                    <select 
                        class="select select-bordered"
                        x-model="sortBy"
                        @change="sortMentors()"
                    >
                        <option value="">ê¸°ë³¸ ì •ë ¬</option>
                        <option value="name" id="name">ì´ë¦„ìˆœ</option>
                        <option value="skill" id="skill">ê¸°ìˆ  ìŠ¤íƒìˆœ</option>
                    </select>
                </div>
                
                <!-- ê²€ìƒ‰ ë²„íŠ¼ -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">&nbsp;</span>
                    </label>
                    <button 
                        class="btn btn-primary"
                        @click="loadMentors()"
                        :disabled="loading"
                    >
                        <span x-show="loading" class="loading loading-spinner loading-xs"></span>
                        <span x-text="loading ? 'ê²€ìƒ‰ ì¤‘...' : 'ê²€ìƒ‰'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ë©˜í†  ëª©ë¡ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <template x-for="mentor in filteredMentors" :key="mentor.id">
            <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow mentor">
                <figure class="px-6 pt-6">
                    <div class="avatar">
                        <div class="w-24 h-24 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                            <img 
                                x-bind:src="`http://localhost:8080/api/images/mentor/${mentor.id}`" 
                                x-bind:alt="mentor.profile.name + ' í”„ë¡œí•„'"
                                onerror="this.src='https://placehold.co/500x500.jpg?text=MENTOR'"
                            />
                        </div>
                    </div>
                </figure>
                
                <div class="card-body items-center text-center">
                    <h2 class="card-title" x-text="mentor.profile.name"></h2>
                    <p class="text-base-content/70 text-sm" x-text="mentor.profile.bio || 'ìê¸°ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.'"></p>
                    
                    <!-- ê¸°ìˆ  ìŠ¤íƒ -->
                    <div class="flex flex-wrap gap-1 mt-2">
                        <template x-for="skill in (mentor.profile.skills || [])" :key="skill">
                            <div class="badge badge-primary badge-sm" x-text="skill"></div>
                        </template>
                        <div x-show="!mentor.profile.skills || mentor.profile.skills.length === 0" class="text-xs text-base-content/50">
                            ê¸°ìˆ  ìŠ¤íƒ ì •ë³´ ì—†ìŒ
                        </div>
                    </div>
                    
                    <div class="card-actions justify-end mt-4">
                        <button 
                            class="btn btn-primary btn-sm"
                            @click="openMatchModal(mentor)"
                            :disabled="hasActiveRequest"
                        >
                            ë§¤ì¹­ ìš”ì²­
                        </button>
                    </div>
                </div>
            </div>
        </template>
        
        <!-- ë¹ˆ ìƒíƒœ -->
        <div x-show="filteredMentors.length === 0 && !loading" class="col-span-full text-center py-12">
            <svg class="w-16 h-16 mx-auto mb-4 text-base-content/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <h3 class="text-xl font-semibold mb-2">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-base-content/70">ë‹¤ë¥¸ ê¸°ìˆ  ìŠ¤íƒìœ¼ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</p>
        </div>
        
        <!-- ë¡œë”© ìƒíƒœ -->
        <div x-show="loading" class="col-span-full text-center py-12">
            <span class="loading loading-spinner loading-lg"></span>
            <p class="mt-4">ë©˜í† ë¥¼ ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
    </div>
    
    <!-- ë§¤ì¹­ ìš”ì²­ ëª¨ë‹¬ -->
    <dialog class="modal" x-bind:class="{'modal-open': showMatchModal}">
        <div class="modal-box">
            <h3 class="font-bold text-lg">ë§¤ì¹­ ìš”ì²­ ë³´ë‚´ê¸°</h3>
            
            <template x-if="selectedMentor">
                <div class="py-4">
                    <div class="flex items-center space-x-4 mb-4">
                        <div class="avatar">
                            <div class="w-16 h-16 rounded-full">
                                <img 
                                    x-bind:src="`http://localhost:8080/api/images/mentor/${selectedMentor.id}`" 
                                    x-bind:alt="selectedMentor.profile.name + ' í”„ë¡œí•„'"
                                    onerror="this.src='https://placehold.co/500x500.jpg?text=MENTOR'"
                                />
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold" x-text="selectedMentor.profile.name"></h4>
                            <p class="text-sm text-base-content/70" x-text="selectedMentor.profile.bio"></p>
                        </div>
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">ë§¤ì¹­ ìš”ì²­ ë©”ì‹œì§€</span>
                        </label>
                        <textarea 
                            class="textarea textarea-bordered h-24" 
                            placeholder="ë©˜í† ì—ê²Œ ë³´ë‚¼ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                            x-model="matchMessage"
                            :id="`message`"
                            :data-mentor-id="selectedMentor ? selectedMentor.id : ''"
                            :data-testid="`message-${selectedMentor ? selectedMentor.id : ''}`"
                        ></textarea>
                    </div>
                </div>
            </template>
            
            <div class="modal-action">
                <button 
                    class="btn btn-primary" 
                    id="request"
                    @click="sendMatchRequest()"
                    :disabled="matchRequestLoading || !matchMessage.trim()"
                >
                    <span x-show="matchRequestLoading" class="loading loading-spinner loading-xs"></span>
                    <span x-text="matchRequestLoading ? 'ìš”ì²­ ì¤‘...' : 'ìš”ì²­ ë³´ë‚´ê¸°'"></span>
                </button>
                <button class="btn" @click="closeMatchModal()">ì·¨ì†Œ</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop" @click="closeMatchModal()">
            <button>close</button>
        </form>
    </dialog>
</div>
{% endblock %}

{% block scripts %}
<script>
function mentorsPage() {
    return {
        mentors: [],
        filteredMentors: [],
        loading: false,
        searchSkill: '',
        sortBy: '',
        showMatchModal: false,
        selectedMentor: null,
        matchMessage: '',
        matchRequestLoading: false,
        hasActiveRequest: false,
        userName: '',
        userImage: 'https://placehold.co/500x500.jpg?text=USER',
        
        async init() {
            await this.loadUserInfo();
            await this.loadMentors();
            await this.checkActiveRequests();
        },
        
        async loadUserInfo() {
            try {
                const response = await axios.get('/me');
                const user = response.data;
                this.userName = user.profile.name;
                this.userImage = `http://localhost:8080/api/images/${user.role}/${user.id}`;
            } catch (error) {
                console.error('Failed to load user info:', error);
            }
        },
        
        async loadMentors() {
            this.loading = true;
            try {
                let url = '/mentors';
                const params = new URLSearchParams();
                
                if (this.searchSkill.trim()) {
                    params.append('skill', this.searchSkill.trim());
                }
                
                if (this.sortBy) {
                    params.append('order_by', this.sortBy);
                }
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                const response = await axios.get(url);
                this.mentors = response.data;
                this.filteredMentors = [...this.mentors];
                
            } catch (error) {
                console.error('Failed to load mentors:', error);
                showToast('ë©˜í†  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            } finally {
                this.loading = false;
            }
        },
        
        async checkActiveRequests() {
            try {
                const response = await axios.get('/match-requests/outgoing');
                const requests = response.data;
                
                // ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ì´ ìˆëŠ”ì§€ í™•ì¸
                this.hasActiveRequest = requests.some(request => request.status === 'pending');
                
            } catch (error) {
                console.error('Failed to check active requests:', error);
            }
        },
        
        searchMentors() {
            if (!this.searchSkill.trim()) {
                this.filteredMentors = [...this.mentors];
                return;
            }
            
            const keyword = this.searchSkill.toLowerCase();
            this.filteredMentors = this.mentors.filter(mentor => 
                mentor.profile.skills && 
                mentor.profile.skills.some(skill => 
                    skill.toLowerCase().includes(keyword)
                )
            );
        },
        
        sortMentors() {
            if (!this.sortBy) {
                this.filteredMentors = [...this.mentors];
                return;
            }
            
            this.filteredMentors.sort((a, b) => {
                if (this.sortBy === 'name') {
                    return a.profile.name.localeCompare(b.profile.name);
                } else if (this.sortBy === 'skill') {
                    const aSkills = a.profile.skills ? a.profile.skills.join(', ') : '';
                    const bSkills = b.profile.skills ? b.profile.skills.join(', ') : '';
                    return aSkills.localeCompare(bSkills);
                }
                return 0;
            });
        },
        
        openMatchModal(mentor) {
            if (this.hasActiveRequest) {
                showToast('ì´ë¯¸ ëŒ€ê¸° ì¤‘ì¸ ë§¤ì¹­ ìš”ì²­ì´ ìˆìŠµë‹ˆë‹¤.', 'warning');
                return;
            }
            
            this.selectedMentor = mentor;
            this.matchMessage = '';
            this.showMatchModal = true;
        },
        
        closeMatchModal() {
            this.showMatchModal = false;
            this.selectedMentor = null;
            this.matchMessage = '';
        },
        
        async sendMatchRequest() {
            if (!this.matchMessage.trim()) {
                showToast('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            this.matchRequestLoading = true;
            
            try {
                // ë‚´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const userResponse = await axios.get('/me');
                const menteeId = userResponse.data.id;
                
                const requestData = {
                    mentorId: this.selectedMentor.id,
                    menteeId: menteeId,
                    message: this.matchMessage.trim()
                };
                
                await axios.post('/match-requests', requestData);
                
                showToast('ë§¤ì¹­ ìš”ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                this.closeMatchModal();
                
                // í™œì„± ìš”ì²­ ìƒíƒœ ì—…ë°ì´íŠ¸
                this.hasActiveRequest = true;
                
            } catch (error) {
                console.error('Match request error:', error);
                showToast(
                    error.response?.data?.error || 'ë§¤ì¹­ ìš”ì²­ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 
                    'error'
                );
            } finally {
                this.matchRequestLoading = false;
            }
        },
        
        logout() {
            localStorage.removeItem('jwt_token');
            delete axios.defaults.headers.common['Authorization'];
            window.location.href = '/';
        }
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ í† í° í™•ì¸
document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('jwt_token');
    if (!token) {
        window.location.href = '/';
    }
});
</script>
{% endblock %}
